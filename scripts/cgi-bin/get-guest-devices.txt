#!/bin/sh
echo "Content-type: application/json"
echo ""

json_escape() {
    echo "$1" | sed 's/\\/\\\\/g; s/"/\\"/g; s/\t/\\t/g; s/\r/\\r/g; s/\n/\\n/g'
}

# Check if device is currently reachable
is_active() {
    local ip="$1"
    # Quick ping test (1 second timeout)
    ping -c 1 -W 1 "$ip" >/dev/null 2>&1
}

echo '{ "devices": ['

TEMP_FILE="/tmp/guest_status.tmp"
> "$TEMP_FILE"

# Get all guest network IPs from DHCP leases
if [ -f /tmp/dhcp.leases ]; then
    grep "70\.70\.71\." /tmp/dhcp.leases 2>/dev/null | while read -r EXP MAC IP HOST ID; do
        if echo "$IP" | grep -qE '^70\.70\.71\.[0-9]{1,3}$'; then
            # Check if device is currently active
            if is_active "$IP"; then
                STATUS="connected"
            else
                STATUS="offline"
            fi

            HOST_ESCAPED=$(json_escape "${HOST:-Unknown}")
            echo "  { \"mac\": \"$MAC\", \"ip\": \"$IP\", \"hostname\": \"$HOST_ESCAPED\", \"status\": \"$STATUS\" }" >> "$TEMP_FILE"
        fi
    done
fi

# Output with proper comma separation
FIRST=1
while IFS= read -r line; do
    [ "$FIRST" -eq 0 ] && echo ","
    echo -n "$line"
    FIRST=0
done < "$TEMP_FILE"

echo ""
echo "] }"

rm -f "$TEMP_FILE"