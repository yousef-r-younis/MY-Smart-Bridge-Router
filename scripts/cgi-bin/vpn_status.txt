#!/bin/ash
echo "Content-type: application/json"
echo ""

vpn_process=$(pgrep -af "openvpn --config")

if [ -n "$vpn_process" ]; then
    vpn_config=$(echo "$vpn_process" | awk '{for (i=1; i<=NF; i++) if ($i=="--config") print $(i+1)}')
    vpn_config_name=$(basename "$vpn_config")
    vpn_pid=$(echo "$vpn_process" | awk '{print $1}')

    # Get additional details if available
    vpn_uptime=$(ps -o etime= -p "$vpn_pid" 2>/dev/null | tr -d ' ')

    cat << EOF
{
  "status": "connected",
  "running": true,
  "config_file": "$vpn_config",
  "config_name": "$vpn_config_name",
  "process_id": $vpn_pid,
  "uptime": "$vpn_uptime",
  "timestamp": "$(date -Iseconds)"
}
EOF
else
    cat << EOF
{
  "status": "disconnected",
  "running": false,
  "config_file": null,
  "config_name": null,
  "process_id": null,
  "uptime": null,
  "timestamp": "$(date -Iseconds)"
}
EOF
fi