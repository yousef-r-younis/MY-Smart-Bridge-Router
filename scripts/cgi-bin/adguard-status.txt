#!/bin/sh

echo "Content-type: text/plain"
echo ""

# Define API endpoints and credentials
STATUS_URL="http://70.70.70.1:8080/control/status"
PROTECTION_URL="http://70.70.70.1:8080/control/dns_config"
USERNAME="Senior_adBlock"
PASSWORD="adblock700800900"

# Get action from query string if present
QUERY_STRING=${QUERY_STRING:-""}
ACTION=$(echo "$QUERY_STRING" | grep -o "action=[^&]*" | cut -d= -f2)

case "$ACTION" in
    "enable")
        # Enable protection
        RESULT=$(curl -s -u "$USERNAME:$PASSWORD" -X POST -H "Content-Type: application/json" \
            -d '{"protection_enabled":true}' "$PROTECTION_URL")
        if echo "$RESULT" | grep -q "success"; then
            echo "enabled"
        else
            echo "error=failed_to_enable"
            echo "$RESULT"
        fi
        ;;
    "disable")
        # Disable protection
        RESULT=$(curl -s -u "$USERNAME:$PASSWORD" -X POST -H "Content-Type: application/json" \
            -d '{"protection_enabled":false}' "$PROTECTION_URL")
        if echo "$RESULT" | grep -q "success"; then
            echo "disabled"
        else
            echo "error=failed_to_disable"
            echo "$RESULT"
        fi
        ;;
    *)
        # Default: just get status
        RESPONSE=$(curl -s -u "$USERNAME:$PASSWORD" "$STATUS_URL")
        if echo "$RESPONSE" | grep -q '"protection_enabled":true'; then
            echo "enabled"
        elif echo "$RESPONSE" | grep -q '"protection_enabled":false'; then
            echo "disabled"
        else
            echo "status=unknown"
            echo "$RESPONSE"
        fi
        ;;
esac