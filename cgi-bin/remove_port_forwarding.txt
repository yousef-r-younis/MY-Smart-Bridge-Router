#!/bin/sh

echo "Content-Type: application/json"
echo ""

# Read full input (multi-line safe)
input=$(cat)

# Extract values
rule_name=$(echo "$input" | jq -r '.rule_name')

# Find the rule index in UCI
rule_index=$(uci show firewall | grep "firewall.@redirect\[[0-9]*\].name='$rule_name'" | awk -F'[][]' '{print $2}')

# Check if rule exists
if [ -z "$rule_index" ]; then
  echo "{\"status\": \"error\", \"message\": \"Rule not found\"}"
  exit 1
fi

# Delete the rule properly
uci delete firewall.@redirect[$rule_index]
uci commit firewall

# Restart firewall to apply changes
/etc/init.d/firewall restart

# Output success response
echo "{\"status\": \"success\", \"message\": \"Rule '$rule_name' removed\"}"
