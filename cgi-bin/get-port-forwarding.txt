#!/bin/sh

echo "Content-Type: application/json"
echo ""

rules="["

# Collect all @redirect entries (not assuming sequential indexes)
indexes=$(uci show firewall | grep "=redirect" | cut -d'[' -f2 | cut -d']' -f1)

for index in $indexes; do
    name=$(uci get firewall.@redirect[$index].name 2>/dev/null)
    src_dport=$(uci get firewall.@redirect[$index].src_dport 2>/dev/null)
    dest_ip=$(uci get firewall.@redirect[$index].dest_ip 2>/dev/null)
    dest_port=$(uci get firewall.@redirect[$index].dest_port 2>/dev/null)
    proto=$(uci get firewall.@redirect[$index].proto 2>/dev/null)

    # Ensure it's a valid entry (must have at least name and src_dport)
    if [ -n "$name" ] && [ -n "$src_dport" ]; then
        rules="${rules}{\"rule_name\":\"$name\",\"external_port\":\"$src_dport\",\"internal_ip\":\"$dest_ip\",\"internal_port\":\"$dest_port\",\"protocols\":\"$proto\"},"
    fi
done

# Finalize JSON: remove trailing comma and close array
rules="${rules%,}]"

echo "$rules"
